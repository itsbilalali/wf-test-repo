name: Merge PR to Main

on:
  pull_request:
    types: [labeled]
    branches:
      - dev

jobs:
  cherry_pick_and_merge:
    if: github.event.label.name == 'merge-to-main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Fetch all history for all branches

      - name: Set up Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Get the PR number and commits
        id: get_pr_commits
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_COMMITS=$(git log dev --pretty=format:"%H" --grep "Merge pull request #$PR_NUMBER")
          echo "PR_COMMITS=$PR_COMMITS" >> $GITHUB_ENV

      - name: Checkout main branch
        run: |
          git checkout main

      - name: Cherry-pick the PR commits
        run: |
          for commit in ${{ env.PR_COMMITS }}; do
            git cherry-pick $commit
          done

      - name: Push changes to main
        run: |
          git push origin main